<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>TeaTrace 茶迹</title>
    
    <!-- 1. 样式框架 Tailwind CSS (通常国内可用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel 用于在浏览器编译 React 代码 (替换为国内 Staticfile CDN 加速) -->
    <script src="https://cdn.staticfile.org/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- 3. Tailwind 配置 (已移除 Google Fonts 引用，使用系统字体) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              tea: {
                50: '#F5F7F5', 100: '#E6EBE6', 200: '#D1DAD1', 300: '#B0BDB0',
                400: '#8F9E8F', 500: '#6B7D6B', 600: '#4A5C4A', 700: '#384538',
                800: '#2A332A', 900: '#1F261F',
              },
              stone: {
                50: '#FAFAF9', 100: '#F5F5F4', 200: '#E7E5E4', 300: '#D6D3D1',
                400: '#A8A29E', 500: '#78716C', 800: '#292524', 900: '#1C1917',
              },
              paper: '#F2F0EB',
            },
            fontFamily: {
              // 使用系统自带的高质量中文字体，无需下载，国内加载极快
              serif: ['"Noto Serif SC"', '"Songti SC"', '"STSong"', '"SimSun"', 'serif'],
              sans: ['"Noto Sans SC"', '"PingFang SC"', '"Microsoft YaHei"', '"Heiti SC"', 'sans-serif'],
            },
            backgroundImage: {
              'texture': "url('https://www.transparenttextures.com/patterns/cream-paper.png')",
            },
            animation: {
              'float': 'float 10s ease-in-out infinite',
              'float-delayed': 'float 12s ease-in-out infinite reverse',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0) scale(1)' },
                '50%': { transform: 'translateY(-20px) scale(1.05)' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- 4. 自定义 CSS -->
    <style>
      html, body, #root { height: 100%; margin: 0; padding: 0; }
      body {
        background-color: #E7E5E4;
        /* 针对 iOS 和 安卓 的字体优化 */
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        -webkit-font-smoothing: antialiased;
        overscroll-behavior-y: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      @media (max-width: 768px) {
        body { display: block; background-color: #F2F0EB; }
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.4);
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.45);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px 0 rgba(100, 100, 100, 0.05);
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      input[type=range] { -webkit-appearance: none; background: transparent; }
      input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
    </style>

    <!-- 5. Import Map 用于模块加载 -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "recharts": "https://esm.sh/recharts@2.10.3",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- 6. 应用主要逻辑代码 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import { BookOpen, PieChart, Coffee, Thermometer, Droplets, Info, X, Check, ChevronRight, Repeat, Feather } from 'lucide-react';
        import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, Tooltip } from 'recharts';
        import { format, subDays } from 'date-fns';
        import { zhCN } from 'date-fns/locale';

        // --- 常量数据 (CONSTANTS) ---
        
        const TEA_LIBRARY = [
          {
            id: 'Green',
            name: '绿茶',
            temp: 80,
            ratio: '1:50',
            rinse: false,
            desc: '清新自然，保留原叶风味。忌高温久泡。',
            color: '#84cc16', 
            image: 'https://images.unsplash.com/photo-1627435601361-ec25f5b1d0e5?auto=format&fit=crop&w=800&q=80'
          },
          {
            id: 'White',
            name: '白茶',
            temp: 90,
            ratio: '1:25',
            rinse: false,
            desc: '自然萎凋，毫香蜜韵，滋味清淡回甘。',
            color: '#e5e7eb',
            image: 'https://images.unsplash.com/photo-1597481499750-3e6b22637e12?auto=format&fit=crop&w=800&q=80'
          },
          {
            id: 'Yellow',
            name: '黄茶',
            temp: 85,
            ratio: '1:50',
            rinse: false,
            desc: '闷黄工艺，滋味醇厚，汤色杏黄。',
            color: '#facc15',
            image: 'https://images.unsplash.com/photo-1582793988951-9aed5509eb97?auto=format&fit=crop&w=800&q=80'
          },
          {
            id: 'Oolong',
            name: '青茶 (乌龙)',
            temp: 100,
            ratio: '1:22',
            rinse: true,
            desc: '半发酵，香气馥郁，讲究高冲低斟。',
            color: '#14b8a6',
            image: 'https://images.unsplash.com/photo-1563822249548-9a72b6353cd1?auto=format&fit=crop&w=800&q=80'
          },
          {
            id: 'Black',
            name: '红茶',
            temp: 95,
            ratio: '1:50',
            rinse: false,
            desc: '全发酵，汤色红亮，滋味甜醇。',
            color: '#b91c1c',
            image: 'https://images.unsplash.com/photo-1594631252845-29fc4cc8cde9?auto=format&fit=crop&w=800&q=80'
          },
          {
            id: 'Dark',
            name: '黑茶',
            temp: 100,
            ratio: '1:20',
            rinse: true,
            desc: '后发酵，越陈越香，可煮可泡。',
            color: '#3f3f46',
            image: 'https://images.unsplash.com/photo-1620025199859-0df8508933bc?auto=format&fit=crop&w=800&q=80'
          }
        ];

        const INITIAL_LOGS = [
          {
            id: '1',
            teaName: '西湖龙井',
            category: 'Green',
            amount: 3,
            temp: 85,
            brewCount: 3,
            rating: 5,
            date: Date.now() - 86400000 * 2,
            notes: '清明前采摘，豆香浓郁。'
          },
          {
            id: '2',
            teaName: '大红袍',
            category: 'Oolong',
            amount: 8,
            temp: 100,
            brewCount: 7,
            rating: 4,
            date: Date.now() - 86400000,
            notes: '岩韵明显，回甘持久。'
          }
        ];

        // --- 组件部分 (COMPONENTS) ---

        // 1. 茶经页面 (TeaLibraryView)
        const TeaLibraryView = () => {
          const [selectedTea, setSelectedTea] = useState(null);

          return (
            <div className="pb-28 pt-6 px-4">
               <div className="mb-6">
                    <h2 className="text-2xl font-serif font-bold text-stone-800 tracking-widest">茶经</h2>
                    <p className="text-[10px] text-stone-500 font-serif tracking-widest mt-1">六大茶类，冲泡指引</p>
               </div>
              
              <div className="space-y-4">
                {TEA_LIBRARY.map((tea, index) => (
                  <motion.div
                    key={tea.id}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.05 }}
                    whileTap={{ scale: 0.98 }}
                    onClick={() => setSelectedTea(tea)}
                    className="group relative h-28 rounded-2xl overflow-hidden cursor-pointer shadow-sm"
                  >
                    <div className="absolute inset-0">
                       <img src={tea.image} alt={tea.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                       <div className="absolute inset-0 bg-stone-900/40 group-hover:bg-stone-900/30 transition-colors"></div>
                       <div className="absolute inset-0 bg-gradient-to-r from-stone-900/90 via-stone-900/40 to-transparent"></div>
                    </div>

                    <div className="absolute inset-0 p-5 flex items-center justify-between">
                        <div className="flex flex-col justify-center z-10">
                            <div className="flex items-center gap-3 mb-1.5">
                                <div className="w-1 h-6 bg-white/80 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)]"></div>
                                <h3 className="text-xl font-serif font-bold text-white tracking-[0.2em] drop-shadow-md">{tea.name}</h3>
                            </div>
                            <p className="text-[10px] text-stone-300 pl-4 tracking-wider font-light opacity-90 line-clamp-1 max-w-[150px]">{tea.desc}</p>
                        </div>

                        <div className="flex items-center gap-4 pr-1 opacity-90 z-10">
                            <div className="flex flex-col items-center">
                                <div className="flex items-center gap-1 mb-0.5">
                                    <Thermometer size={10} className="text-stone-300" />
                                    <span className="text-xs font-mono font-bold text-white">{tea.temp}°</span>
                                </div>
                                <div className="h-0.5 w-6 bg-white/20 rounded-full"></div>
                            </div>
                            
                            <div className="flex flex-col items-center">
                                <div className="flex items-center gap-1 mb-0.5">
                                    <Droplets size={10} className="text-stone-300" />
                                    <span className="text-xs font-mono font-bold text-white">{tea.ratio}</span>
                                </div>
                                <div className="h-0.5 w-6 bg-white/20 rounded-full"></div>
                            </div>
                            
                            <div className="ml-1 w-8 h-8 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center border border-white/20 group-hover:bg-white/20 transition-colors">
                                 <ChevronRight size={16} className="text-white opacity-80" />
                            </div>
                        </div>
                    </div>
                    
                    <div className="absolute right-0 top-0 bottom-0 w-1 opacity-50" style={{ backgroundColor: tea.color }}></div>

                  </motion.div>
                ))}
              </div>

              <AnimatePresence>
                {selectedTea && (
                  <>
                    <motion.div 
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      onClick={() => setSelectedTea(null)}
                      className="absolute inset-0 bg-stone-900/60 backdrop-blur-sm z-40"
                    />
                    <motion.div
                      layoutId={selectedTea.id}
                      initial={{ y: "100%" }}
                      animate={{ y: 0 }}
                      exit={{ y: "100%" }}
                      transition={{ type: "spring", damping: 30, stiffness: 300 }}
                      className="absolute bottom-0 left-0 right-0 z-50 rounded-t-[2rem] overflow-hidden bg-[#F7F7F2] max-h-[85%] h-auto flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.1)]"
                    >
                        <div className="relative h-64 shrink-0">
                           <img src={selectedTea.image} className="w-full h-full object-cover" alt={selectedTea.name} />
                           
                           <div className="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-[#F7F7F2]"></div>

                           <button 
                            onClick={() => setSelectedTea(null)}
                            className="absolute top-5 right-5 bg-white/20 backdrop-blur-md p-1.5 rounded-full text-white border border-white/20 z-10"
                           >
                             <X size={18} />
                           </button>

                           <div className="absolute bottom-0 left-0 right-0 p-6">
                                <motion.h2 
                                    initial={{ y: 20, opacity: 0 }}
                                    animate={{ y: 0, opacity: 1 }}
                                    transition={{ delay: 0.2 }}
                                    className="text-3xl font-serif font-bold text-stone-900 tracking-widest"
                                >
                                    {selectedTea.name}
                                </motion.h2>
                           </div>
                        </div>

                        <div className="flex-1 overflow-y-auto no-scrollbar relative z-10">
                            <div className="px-6 pb-10 space-y-6 -mt-2">
                                <p className="text-stone-600 leading-loose font-serif text-justify tracking-wide text-sm">
                                    {selectedTea.desc}
                                </p>
                                <div className="grid grid-cols-3 gap-3">
                                    {[
                                        { icon: Thermometer, label: '适宜水温', val: `${selectedTea.temp}°C`, color: 'text-tea-600' },
                                        { icon: Droplets, label: '茶水比例', val: selectedTea.ratio, color: 'text-blue-500' },
                                        { icon: Info, label: '润茶建议', val: selectedTea.rinse ? '需润茶' : '不推荐', color: 'text-stone-500' }
                                    ].map((item, i) => (
                                        <div key={i} className="bg-white/50 border border-stone-200/50 p-3 rounded-xl flex flex-col items-center justify-center text-center shadow-sm">
                                            <item.icon className={`${item.color} mb-1.5 opacity-80`} size={18} />
                                            <span className="text-[9px] text-stone-400 mb-0.5 tracking-wider">{item.label}</span>
                                            <span className="text-sm font-bold text-stone-800 font-serif">{item.val}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-tea-50/50 border border-tea-100/50 p-5 rounded-2xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-3 opacity-5">
                                        <span className="text-5xl font-serif">泡</span>
                                    </div>
                                    <h3 className="font-serif font-bold text-stone-800 mb-4 text-base tracking-widest">冲泡要义</h3>
                                    <div className="space-y-4 relative">
                                        <div className="absolute left-[6px] top-2 bottom-2 w-[1px] bg-tea-200"></div>
                                        {[
                                            { title: '择器', content: selectedTea.id === 'Green' ? '玻璃杯赏舞' : selectedTea.id === 'Oolong' ? '紫砂壶聚香' : '白瓷盖碗' },
                                            { title: '温杯', content: '沸水润具，激发干茶香气' },
                                            { title: '注水', content: selectedTea.id === 'Green' ? '环壁注水，忌直冲' : '悬壶高冲，激扬茶韵' }
                                        ].map((step, idx) => (
                                            <div key={idx} className="relative pl-5">
                                                <div className="absolute left-0 top-1.5 w-[13px] h-[13px] rounded-full bg-[#F7F7F2] border border-tea-400 flex items-center justify-center">
                                                    <div className="w-1 h-1 rounded-full bg-tea-400"></div>
                                                </div>
                                                <h4 className="font-serif font-bold text-stone-800 text-sm mb-0.5">{step.title}</h4>
                                                <p className="text-[11px] text-stone-600 leading-relaxed">{step.content}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </motion.div>
                  </>
                )}
              </AnimatePresence>
            </div>
          );
        };

        // 2. 记录表单 (LogForm)
        const LogForm = ({ onClose, onSave }) => {
          const [formData, setFormData] = useState({
            teaName: '',
            category: 'Green',
            amount: 5,
            temp: 85,
            brewCount: 3,
            rating: 4,
            notes: ''
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave({ ...formData, date: Date.now() });
            onClose();
          };

          const categories = TEA_LIBRARY.map(c => ({ id: c.id, name: c.name }));

          const Slider = ({ label, value, min, max, step, unit, onChange }) => (
            <div className="mb-5">
                <div className="flex justify-between mb-2 items-end">
                    <label className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">{label}</label>
                    <span className="text-lg font-serif font-bold text-tea-700">{value}<span className="text-[10px] font-sans text-stone-400 ml-0.5 font-normal">{unit}</span></span>
                </div>
                <div className="relative h-1.5 w-full">
                    <div className="absolute top-0 left-0 right-0 bottom-0 bg-stone-200 rounded-full h-1.5"></div>
                    <div 
                        className="absolute top-0 left-0 bottom-0 bg-tea-500 rounded-full h-1.5"
                        style={{ width: `${((value - min) / (max - min)) * 100}%` }}
                    ></div>
                    <input 
                        type="range" min={min} max={max} step={step}
                        value={value}
                        onChange={onChange}
                        className="absolute top-[-5px] left-0 w-full h-4 opacity-0 cursor-pointer z-10"
                    />
                    <div 
                        className="absolute top-[-3px] h-3 w-3 bg-white border-2 border-tea-600 rounded-full shadow-md pointer-events-none transition-all"
                        style={{ left: `calc(${((value - min) / (max - min)) * 100}% - 6px)` }}
                    ></div>
                </div>
            </div>
          );

          return (
            <motion.div
                initial={{ y: "100%" }}
                animate={{ y: 0 }}
                exit={{ y: "100%" }}
                transition={{ type: "spring", damping: 25, stiffness: 200 }}
                className="absolute inset-0 z-50 flex flex-col bg-[#F7F7F2]"
            >
                <div className="pt-4 pb-3 px-4 flex justify-between items-center bg-[#F7F7F2] z-10">
                    <button onClick={onClose} className="p-2 -ml-2 rounded-full text-stone-400 hover:text-stone-800 transition-colors">
                        <X size={20} />
                    </button>
                    <h2 className="font-serif font-bold text-base text-stone-800 tracking-widest">品茗录</h2>
                    <div className="w-8"></div>
                </div>

                <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto px-4 space-y-8 pb-28">
                    <div className="space-y-5">
                        <input 
                            required
                            type="text" 
                            value={formData.teaName}
                            onChange={e => setFormData({...formData, teaName: e.target.value})}
                            placeholder="茶名..."
                            className="w-full bg-transparent border-b border-stone-300 py-1.5 text-2xl font-serif text-stone-900 placeholder-stone-300 focus:outline-none focus:border-tea-600 transition-colors text-center"
                        />
                        <div className="flex flex-wrap justify-center gap-2">
                            {categories.map(cat => (
                                <button
                                    key={cat.id}
                                    type="button"
                                    onClick={() => {
                                        const defaultTemp = TEA_LIBRARY.find(t => t.id === cat.id)?.temp || 85;
                                        setFormData({...formData, category: cat.id, temp: defaultTemp});
                                    }}
                                    className={`px-3 py-1.5 rounded-full text-[10px] font-medium tracking-wide transition-all border ${
                                        formData.category === cat.id 
                                        ? 'bg-tea-600 border-tea-600 text-white shadow-lg shadow-tea-600/20' 
                                        : 'bg-transparent border-stone-200 text-stone-500 hover:border-stone-400'
                                    }`}
                                >
                                    {cat.name}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="h-px bg-stone-200 w-full"></div>

                    <div className="space-y-6">
                        <Slider label="投茶量" value={formData.amount} unit="g" min={1} max={15} step={0.5} onChange={(e) => setFormData({...formData, amount: parseFloat(e.target.value)})} />
                        <Slider label="水温" value={formData.temp} unit="°C" min={60} max={100} step={1} onChange={(e) => setFormData({...formData, temp: parseInt(e.target.value)})} />
                        <Slider label="冲泡" value={formData.brewCount} unit="泡" min={1} max={20} step={1} onChange={(e) => setFormData({...formData, brewCount: parseInt(e.target.value)})} />
                    </div>

                    <div className="text-center">
                         <label className="block text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-3">综合评分</label>
                         <div className="flex gap-4 justify-center">
                            {[1, 2, 3, 4, 5].map((star) => (
                                <button
                                    key={star}
                                    type="button"
                                    onClick={() => setFormData({...formData, rating: star})}
                                    className={`text-xl transition-all ${star <= formData.rating ? 'text-yellow-600 scale-110' : 'text-stone-200'}`}
                                >
                                    ★
                                </button>
                            ))}
                         </div>
                    </div>

                    <div className="bg-white/50 p-3 rounded-xl border border-stone-200 focus-within:border-tea-400 transition-colors">
                        <textarea 
                            value={formData.notes}
                            onChange={e => setFormData({...formData, notes: e.target.value})}
                            placeholder="记录此时此刻的香气、滋味与心境..."
                            rows={3}
                            className="w-full bg-transparent font-serif text-sm text-stone-700 placeholder-stone-300 focus:outline-none resize-none leading-relaxed"
                        />
                    </div>
                </form>

                <div className="absolute bottom-6 left-4 right-4 z-20">
                    <button 
                        onClick={handleSubmit}
                        className="w-full bg-stone-800 text-stone-50 py-3.5 rounded-xl font-serif font-bold text-base shadow-xl shadow-stone-900/10 flex items-center justify-center gap-2 active:scale-95 transition-transform"
                    >
                        <Check size={18} />
                        <span>完成记录</span>
                    </button>
                </div>
            </motion.div>
          );
        };

        // 3. 数据分析 (StatsView)
        const StatsView = ({ logs }) => {
          const categoryData = TEA_LIBRARY.map(cat => {
            const count = logs.filter(l => l.category === cat.id).length;
            return {
              name: cat.name,
              value: count,
              color: cat.color
            };
          }).filter(item => item.value > 0);

          const today = new Date();
          const last7Days = Array.from({ length: 7 }, (_, i) => {
            const d = subDays(today, 6 - i);
            const count = logs.filter(l => {
                const logDate = new Date(l.date);
                return logDate.getDate() === d.getDate() && logDate.getMonth() === d.getMonth();
            }).length;
            return {
                date: format(d, 'MM/dd'),
                count: count
            };
          });

          const totalBrews = logs.reduce((acc, curr) => acc + curr.brewCount, 0);

          return (
            <div className="pb-28 pt-6 px-4">
              <div className="mb-6">
                <h2 className="text-2xl font-serif font-bold text-stone-800 tracking-widest">数据</h2>
                <p className="text-[10px] text-stone-500 font-serif tracking-widest mt-1">日积月累，自有分晓</p>
              </div>

              <div className="grid grid-cols-2 gap-3 mb-5">
                <div className="glass-card p-4 rounded-xl flex flex-col justify-between h-24">
                    <div className="w-7 h-7 rounded-full bg-tea-100 flex items-center justify-center text-tea-600 mb-1">
                        <span className="font-serif text-base">记</span>
                    </div>
                    <div>
                        <p className="text-2xl font-serif font-bold text-stone-800">{logs.length}</p>
                        <p className="text-[9px] text-stone-400 tracking-wider uppercase">累计记录</p>
                    </div>
                </div>
                <div className="glass-card p-4 rounded-xl flex flex-col justify-between h-24">
                    <div className="w-7 h-7 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 mb-1">
                        <span className="font-serif text-base">泡</span>
                    </div>
                     <div>
                        <p className="text-2xl font-serif font-bold text-stone-800">{totalBrews}</p>
                        <p className="text-[9px] text-stone-400 tracking-wider uppercase">累计冲泡</p>
                    </div>
                </div>
              </div>

              {logs.length === 0 ? (
                <div className="glass-card p-10 rounded-2xl text-center">
                    <p className="font-serif text-stone-400 tracking-wider text-sm">暂无数据分析</p>
                </div>
              ) : (
                <>
                    <div className="glass-card p-5 rounded-2xl mb-5">
                        <h3 className="font-serif font-bold text-stone-800 mb-4 tracking-wide text-xs border-l-2 border-tea-500 pl-2">偏好分布</h3>
                        <div className="h-44 w-full relative">
                            <ResponsiveContainer width="100%" height="100%">
                                <RePieChart>
                                <Pie
                                    data={categoryData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={40}
                                    outerRadius={60}
                                    paddingAngle={5}
                                    dataKey="value"
                                    stroke="none"
                                >
                                    {categoryData.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                </Pie>
                                </RePieChart>
                            </ResponsiveContainer>
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="text-center">
                                    <span className="block text-[10px] text-stone-400">种类</span>
                                    <span className="block font-serif font-bold text-stone-700">{categoryData.length}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap justify-center gap-x-3 gap-y-2 mt-1">
                            {categoryData.map((d) => (
                                <div key={d.name} className="flex items-center text-[10px] text-stone-500">
                                    <span className="w-1.5 h-1.5 rounded-full mr-1" style={{backgroundColor: d.color}}></span>
                                    {d.name} <span className="ml-1 opacity-50">{d.value}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="glass-card p-5 rounded-2xl">
                        <h3 className="font-serif font-bold text-stone-800 mb-4 tracking-wide text-xs border-l-2 border-tea-500 pl-2">近七日趋势</h3>
                        <div className="h-32 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={last7Days}>
                            <XAxis 
                                dataKey="date" 
                                tickLine={false}
                                axisLine={false}
                                tick={{fontSize: 8, fill: '#9ca3af', fontFamily: 'sans-serif'}}
                                dy={8}
                            />
                            <Tooltip
                                 cursor={{fill: 'rgba(0,0,0,0.02)'}}
                                 contentStyle={{ 
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)', 
                                    border: 'none',
                                    borderRadius: '8px',
                                    boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                                    fontFamily: 'Noto Serif SC',
                                    fontSize: '12px'
                                }} 
                            />
                            <Bar dataKey="count" fill="#8F9E8F" radius={[3, 3, 3, 3]} barSize={10} activeBar={{fill: '#4A5C4A'}} />
                            </BarChart>
                        </ResponsiveContainer>
                        </div>
                    </div>
                </>
              )}
            </div>
          );
        };

        // 4. 历史记录 (HistoryView)
        const HistoryView = ({ logs, onAddClick }) => {
          const sortedLogs = [...logs].sort((a, b) => b.date - a.date);

          return (
            <div className="pb-28 pt-6 px-4 min-h-screen relative">
               <div className="flex justify-between items-end mb-6">
                    <div>
                        <h2 className="text-2xl font-serif font-bold text-stone-800 tracking-widest">茶迹</h2>
                        <p className="text-[10px] text-stone-500 font-serif tracking-widest mt-1">一期一会，难得一面</p>
                    </div>
                    <motion.button 
                        whileTap={{ scale: 0.95 }}
                        onClick={onAddClick}
                        className="bg-tea-800 text-tea-50 px-4 py-2 rounded-xl text-xs font-serif tracking-wide shadow-lg shadow-tea-900/20 hover:bg-tea-900 transition-colors"
                    >
                        记一盏
                    </motion.button>
               </div>

              <div className="relative border-l border-tea-200/50 ml-3 space-y-4 min-h-[50vh]">
                {sortedLogs.length === 0 ? (
                   <div className="flex flex-col items-center justify-center py-24 ml-[-0.75rem] opacity-70">
                       <div className="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mb-5 border border-white shadow-sm">
                           <Feather size={24} className="text-tea-400 opacity-60" />
                       </div>
                       <h3 className="font-serif font-bold text-stone-600 tracking-[0.2em] mb-2 text-sm">暂无茶迹</h3>
                       <p className="font-serif text-[10px] text-stone-400 tracking-widest">且试新茶，莫负好时光</p>
                       <div className="mt-8 w-8 h-[1px] bg-tea-200/50"></div>
                   </div>
                ) : (
                    sortedLogs.map((log, index) => {
                        const categoryInfo = TEA_LIBRARY.find(c => c.id === log.category);
                        const logDate = new Date(log.date);
                        
                        return (
                            <motion.div 
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                transition={{ delay: index * 0.05 }}
                                key={log.id} 
                                className="relative pl-6"
                            >
                                <div className="absolute left-[-5px] top-6 w-2.5 h-2.5 rounded-full bg-tea-100 border-2 border-tea-400 z-10"></div>
                                
                                <div className="glass-card p-0 rounded-xl overflow-hidden group hover:bg-white/60 transition-colors duration-300">
                                    <div className="flex">
                                        <div className="w-12 bg-stone-100/50 flex flex-col items-center justify-center border-r border-white/50 py-3">
                                            <span className="font-serif text-lg font-bold text-stone-800 leading-none">{format(logDate, 'dd')}</span>
                                            <span className="text-[9px] text-stone-500 uppercase mt-0.5 tracking-wider">{format(logDate, 'MMM', { locale: zhCN })}</span>
                                            <div className="w-0.5 h-3 bg-tea-200 my-1.5"></div>
                                            <span className="text-[9px] text-stone-400 font-mono">{format(logDate, 'HH:mm')}</span>
                                        </div>

                                        <div className="flex-1 p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="text-base font-serif font-bold text-stone-800 tracking-wide">{log.teaName}</h3>
                                                    <div className="flex items-center gap-2 mt-0.5">
                                                        <span className="w-1.5 h-1.5 rounded-full" style={{backgroundColor: categoryInfo?.color}}></span>
                                                        <span className="text-[10px] text-stone-500 font-medium tracking-wide">
                                                            {categoryInfo?.name}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-0.5">
                                                    {[1, 2, 3, 4, 5].map((star) => (
                                                        <span key={star} className={`text-[10px] ${star <= log.rating ? 'text-yellow-600' : 'text-gray-200'}`}>★</span>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 gap-2 py-2 border-t border-stone-200/30 border-dashed">
                                                <div className="flex flex-col">
                                                    <span className="text-[9px] text-stone-400 mb-0.5">水温</span>
                                                    <div className="flex items-center gap-1 text-stone-700 font-medium">
                                                        <Thermometer size={10} className="text-tea-400" />
                                                        <span className="text-xs font-serif">{log.temp}°</span>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col border-l border-stone-200/30 pl-2">
                                                    <span className="text-[9px] text-stone-400 mb-0.5">投茶</span>
                                                    <div className="flex items-center gap-1 text-stone-700 font-medium">
                                                        <Droplets size={10} className="text-blue-300" />
                                                        <span className="text-xs font-serif">{log.amount}g</span>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col border-l border-stone-200/30 pl-2">
                                                    <span className="text-[9px] text-stone-400 mb-0.5">次数</span>
                                                    <div className="flex items-center gap-1 text-stone-700 font-medium">
                                                        <Repeat size={10} className="text-orange-300" />
                                                        <span className="text-xs font-serif">{log.brewCount}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {log.notes && (
                                                <div className="mt-1.5 pt-1.5 text-xs text-stone-600 font-serif leading-relaxed opacity-80">
                                                    {log.notes}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </motion.div>
                        );
                    })
                )}
              </div>
            </div>
          );
        };

        // --- 主程序 (MAIN APP) ---
        const App = () => {
          const [activeTab, setActiveTab] = useState('log');
          const [logs, setLogs] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [isLoading, setIsLoading] = useState(true);

          useEffect(() => {
            const savedLogs = localStorage.getItem('teatrace_logs');
            if (savedLogs) {
              setLogs(JSON.parse(savedLogs));
            } else {
              setLogs(INITIAL_LOGS);
            }
            setIsLoading(false);
          }, []);

          useEffect(() => {
            if (!isLoading) {
              localStorage.setItem('teatrace_logs', JSON.stringify(logs));
            }
          }, [logs, isLoading]);

          const handleSaveLog = (newLog) => {
            const log = {
              ...newLog,
              id: crypto.randomUUID()
            };
            setLogs([log, ...logs]);
          };

          return (
            <div className="w-full h-full relative bg-texture bg-repeat overflow-hidden md:w-[390px] md:h-[844px] md:max-h-[95vh] md:rounded-[45px] md:shadow-2xl md:border-[6px] md:border-white/50">
                <div className="absolute top-[-15%] left-[-10%] w-[70%] h-[40%] bg-tea-200/30 rounded-full blur-[100px] pointer-events-none z-0 animate-float"></div>
                <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[50%] bg-stone-300/20 rounded-full blur-[90px] pointer-events-none z-0 animate-float-delayed"></div>

                <main className="flex-1 h-full overflow-y-auto no-scrollbar relative z-10 scroll-smooth">
                    {activeTab === 'library' && <TeaLibraryView />}
                    {activeTab === 'stats' && <StatsView logs={logs} />}
                    {activeTab === 'log' && (
                        <HistoryView 
                            logs={logs} 
                            onAddClick={() => setShowForm(true)} 
                        />
                    )}
                </main>

                <div className="absolute bottom-6 left-0 right-0 flex justify-center z-20 pointer-events-none">
                    <div className="glass-panel px-6 py-3 rounded-full flex items-center gap-8 shadow-2xl shadow-stone-900/5 pointer-events-auto ring-1 ring-white/50 bg-white/80 backdrop-blur-xl">
                        <button 
                            onClick={() => setActiveTab('log')}
                            className={`flex flex-col items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${activeTab === 'log' ? 'text-tea-800 scale-110' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <Coffee strokeWidth={activeTab === 'log' ? 2.5 : 1.5} size={22} />
                            <div className={`w-1 h-1 rounded-full bg-tea-800 mt-1 transition-opacity ${activeTab === 'log' ? 'opacity-100' : 'opacity-0'}`}></div>
                        </button>
                        <div className="w-px h-6 bg-stone-300/50"></div>
                        <button 
                            onClick={() => setActiveTab('library')}
                            className={`flex flex-col items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${activeTab === 'library' ? 'text-tea-800 scale-110' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <BookOpen strokeWidth={activeTab === 'library' ? 2.5 : 1.5} size={22} />
                            <div className={`w-1 h-1 rounded-full bg-tea-800 mt-1 transition-opacity ${activeTab === 'library' ? 'opacity-100' : 'opacity-0'}`}></div>
                        </button>
                         <div className="w-px h-6 bg-stone-300/50"></div>
                        <button 
                            onClick={() => setActiveTab('stats')}
                            className={`flex flex-col items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${activeTab === 'stats' ? 'text-tea-800 scale-110' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <PieChart strokeWidth={activeTab === 'stats' ? 2.5 : 1.5} size={22} />
                            <div className={`w-1 h-1 rounded-full bg-tea-800 mt-1 transition-opacity ${activeTab === 'stats' ? 'opacity-100' : 'opacity-0'}`}></div>
                        </button>
                    </div>
                </div>

                <AnimatePresence>
                    {showForm && (
                        <LogForm 
                            onClose={() => setShowForm(false)} 
                            onSave={handleSaveLog} 
                        />
                    )}
                </AnimatePresence>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>